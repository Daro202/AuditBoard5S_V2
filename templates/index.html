{% extends "base.html" %}

{% block title %}Audyt 5S - Formularz{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Formularz Audytu 5S
                </h3>
            </div>
            <div class="card-body">
                {% if no_data %}
                    <!-- No data state -->
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Brak danych w systemie</h4>
                        <p class="text-muted mb-4">Aby rozpocząć audyt, należy wczytać dane z pliku Excel.</p>
                        
                        <form method="POST" action="{{ url_for('upload_excel') }}" enctype="multipart/form-data" class="d-inline">
                            <div class="mb-3">
                                <label for="excel_file" class="form-label">Wybierz plik Excel z danymi:</label>
                                <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                                <div class="form-text">
                                    Plik powinien zawierać 2 arkusze: pierwszy z maszynami, drugi z pytaniami (kod, opis).
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload me-1"></i>
                                Wczytaj dane
                            </button>
                        </form>
                    </div>
                    
                {% elif completed %}
                    <!-- All audits completed -->
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h4 class="text-success">Wszystkie audyty zostały ukończone!</h4>
                        <p class="text-muted mb-4">Wszystkie pary maszyna-pytanie zostały już sprawdzone.</p>
                        
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                                <i class="fas fa-chart-line me-1"></i>
                                Zobacz wyniki
                            </a>
                            <a href="{{ url_for('reset_session') }}" class="btn btn-secondary">
                                <i class="fas fa-redo me-1"></i>
                                Rozpocznij nową sesję
                            </a>
                        </div>
                    </div>
                    
                {% else %}
                    <!-- Active audit form -->
                    <div class="audit-card mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-box bg-info text-white p-3 rounded">
                                    <h5>
                                        <i class="fas fa-cog me-2"></i>
                                        Maszyna
                                    </h5>
                                    <h4 class="fw-bold">{{ machine.name }}</h4>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box bg-warning text-dark p-3 rounded">
                                    <h5>
                                        <i class="fas fa-question-circle me-2"></i>
                                        Pytanie: {{ question.code }}
                                    </h5>
                                    <p class="mb-0">{{ question.description }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit form -->
                    <form method="POST" action="{{ url_for('submit_audit') }}" enctype="multipart/form-data">
                        <input type="hidden" name="session_id" value="{{ session_id }}">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Status selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Status audytu *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="status" id="status_ok" value="OK" required>
                                        <label class="btn btn-outline-success" for="status_ok">
                                            <i class="fas fa-check me-1"></i>
                                            OK
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="status" id="status_nok" value="NOK" required>
                                        <label class="btn btn-outline-danger" for="status_nok">
                                            <i class="fas fa-times me-1"></i>
                                            NOK
                                        </label>
                                    </div>
                                </div>

                                <!-- Action completed checkbox (only for NOK) -->
                                <div class="mb-3" id="action-completed-section" style="display: none;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="action_completed" id="action_completed">
                                        <label class="form-check-label fw-bold text-info" for="action_completed">
                                            <i class="fas fa-check-double me-1"></i>
                                            Działanie zakończone pozytywnie
                                        </label>
                                        <div class="form-text">
                                            Zaznacz jeśli podjęto działania naprawcze i problem został rozwiązany
                                        </div>
                                    </div>
                                </div>

                                <!-- Auditor name -->
                                <div class="mb-3">
                                    <label for="auditor_name" class="form-label">Imię audytora</label>
                                    <input type="text" class="form-control" id="auditor_name" name="auditor_name" placeholder="Opcjonalne">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Photo upload -->
                                <div class="mb-3">
                                    <label class="form-label">Zdjęcie dokumentujące</label>
                                    
                                    <!-- Mobile: Camera button (visible on mobile) -->
                                    <div id="mobile-photo-section" class="d-none">
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-lg" onclick="document.getElementById('photo-camera').click()">
                                                <i class="fas fa-camera me-2"></i>
                                                Zrób zdjęcie aparatem
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('photo-gallery').click()">
                                                <i class="fas fa-images me-2"></i>
                                                Wybierz z galerii
                                            </button>
                                        </div>
                                        <input type="file" id="photo-camera" name="photo" 
                                               accept="image/*" capture="environment" 
                                               onchange="fileSelected(this)" class="d-none">
                                        <input type="file" id="photo-gallery" name="photo" 
                                               accept="image/*,image/heic,image/heif" 
                                               onchange="fileSelected(this)" class="d-none">
                                        <div id="mobile-photo-preview" class="mt-2 text-success d-none">
                                            <i class="fas fa-check-circle me-1"></i>
                                            <span id="mobile-photo-name"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Desktop: Standard file input (visible on desktop) -->
                                    <div id="desktop-photo-section">
                                        <input type="file" class="form-control" id="photo" name="photo" 
                                               accept="image/*,image/heic,image/heif" onchange="fileSelected(this)">
                                    </div>
                                    
                                    <div class="form-text">
                                        Dozwolone formaty: JPG, PNG, GIF, HEIC (max 32MB)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label for="description" class="form-label fw-bold">
                                <span id="description-label">Opis *</span>
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="4" required 
                                placeholder="Opisz stan maszyny..."></textarea>
                        </div>

                        <!-- Submit buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-1"></i>
                                Zapisz audyt
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>

        <!-- Tools section -->
        {% if not no_data and not completed %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Narzędzia
                </h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line me-1"></i>
                        Tablica audytowa
                    </a>
                    <a href="{{ url_for('reset_session') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i>
                        Reset sesji
                    </a>
                    <a href="{{ url_for('export_excel') }}" class="btn btn-outline-success">
                        <i class="fas fa-download me-1"></i>
                        Pobierz dane
                    </a>
                </div>
                
                <!-- Excel upload for data update -->
                <hr>
                <form method="POST" action="{{ url_for('upload_excel') }}" enctype="multipart/form-data" class="d-inline">
                    <div class="input-group">
                        <input type="file" class="form-control" name="excel_file" accept=".xlsx,.xls">
                        <button type="submit" class="btn btn-outline-info">
                            <i class="fas fa-upload me-1"></i>
                            Aktualizuj dane
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Detect mobile device
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
           || (window.innerWidth <= 768);
}

// Enhanced file selection handler
function fileSelected(input) {
    const file = input.files[0];
    if (file) {
        const sizeKB = Math.round(file.size/1024);
        const sizeMB = Math.round(file.size/1024/1024);
        
        // Check file size
        const maxSize = 32 * 1024 * 1024; // 32MB
        if (file.size > maxSize) {
            alert('Plik jest za duży. Maksymalny rozmiar to 32MB.');
            input.value = '';
            return;
        }
        
        // Show mobile preview
        const mobilePreview = document.getElementById('mobile-photo-preview');
        const mobilePhotoName = document.getElementById('mobile-photo-name');
        if (mobilePreview && mobilePhotoName && isMobileDevice()) {
            mobilePhotoName.textContent = file.name + ' (' + (sizeMB > 0 ? sizeMB + 'MB' : sizeKB + 'KB') + ')';
            mobilePreview.classList.remove('d-none');
        }
        
        // Convert to Base64 for mobile
        if (isMobileDevice()) {
            convertToBase64(file);
        }
        
        console.log('File selected:', file.name, file.size, file.type);
    }
}

// Convert and compress file to Base64 for mobile compatibility
function convertToBase64(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Resize if too large (max 1200px)
            const maxSize = 1200;
            let width = img.width;
            let height = img.height;
            
            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = Math.round(height * maxSize / width);
                    width = maxSize;
                } else {
                    width = Math.round(width * maxSize / height);
                    height = maxSize;
                }
            }
            
            // Create canvas and compress
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Compress to JPEG with 70% quality
            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
            
            let hiddenInput = document.getElementById('photo_base64');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'photo_base64';
                hiddenInput.id = 'photo_base64';
                document.querySelector('form[action="/submit_audit"]').appendChild(hiddenInput);
            }
            
            let filenameInput = document.getElementById('photo_filename');
            if (!filenameInput) {
                filenameInput = document.createElement('input');
                filenameInput.type = 'hidden';
                filenameInput.name = 'photo_filename';
                filenameInput.id = 'photo_filename';
                document.querySelector('form[action="/submit_audit"]').appendChild(filenameInput);
            }
            
            hiddenInput.value = compressedBase64;
            // Change extension to jpg since we converted
            const baseName = file.name.replace(/\.[^/.]+$/, '');
            filenameInput.value = baseName + '.jpg';
            
            console.log('Photo compressed and converted to Base64');
            console.log('Original size:', Math.round(e.target.result.length / 1024), 'KB');
            console.log('Compressed size:', Math.round(compressedBase64.length / 1024), 'KB');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Update form labels based on status selection
document.addEventListener('DOMContentLoaded', function() {
    // Show mobile or desktop photo section
    const mobileSection = document.getElementById('mobile-photo-section');
    const desktopSection = document.getElementById('desktop-photo-section');
    
    if (mobileSection && desktopSection) {
        if (isMobileDevice()) {
            mobileSection.classList.remove('d-none');
            desktopSection.classList.add('d-none');
        } else {
            mobileSection.classList.add('d-none');
            desktopSection.classList.remove('d-none');
        }
    }
    const statusRadios = document.querySelectorAll('input[name="status"]');
    const descriptionLabel = document.getElementById('description-label');
    const descriptionTextarea = document.getElementById('description');
    const actionCompletedSection = document.getElementById('action-completed-section');
    
    statusRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'OK') {
                descriptionLabel.textContent = 'Opis zgodności *';
                descriptionTextarea.placeholder = 'Opisz potwierdzenie stanu OK...';
                actionCompletedSection.style.display = 'none';
            } else if (this.value === 'NOK') {
                descriptionLabel.textContent = 'Opis problemu *';
                descriptionTextarea.placeholder = 'Opisz wykrytą niezgodność...';
                actionCompletedSection.style.display = 'block';
            }
        });
    });
    
    // Form validation
    const auditForm = document.querySelector('form[action="/submit_audit"]');
    if (auditForm) {
        auditForm.addEventListener('submit', function(event) {
            const status = this.querySelector('input[name="status"]:checked');
            const description = this.querySelector('textarea[name="description"]');
            
            if (!status) {
                event.preventDefault();
                alert('Wybierz status audytu (OK/NOK)');
                return false;
            }
            
            if (!description || !description.value.trim()) {
                event.preventDefault();
                alert('Wprowadź opis audytu');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
