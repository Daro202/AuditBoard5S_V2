{% extends "base.html" %}

{% block title %}Audyt 5S - Tablica{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-chart-line me-2"></i>
        Tablica Audytowa 5S
    </h2>
    <div class="btn-group" role="group">
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="fas fa-clipboard-check me-1"></i>
            Powrót do audytu
        </a>
    </div>
</div>

{% if machines and questions %}
    <!-- Legend -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="card-title">Legenda:</h6>
            <div class="d-flex flex-wrap gap-3">
                <span class="badge bg-success p-2">
                    <i class="fas fa-check me-1"></i>
                    OK - Status zgodny
                </span>
                <span class="badge bg-danger p-2">
                    <i class="fas fa-times me-1"></i>
                    NIE - Niezgodność
                </span>
                <span class="badge bg-secondary p-2">
                    <i class="fas fa-question me-1"></i>
                    Brak audytu
                </span>
            </div>
        </div>
    </div>

    <!-- Audit matrix table -->
    <div class="table-responsive">
        <table class="table table-bordered audit-matrix">
            <thead class="table-dark">
                <tr>
                    <th class="sticky-left">Maszyna / Pytanie</th>
                    {% for question in questions %}
                        <th class="text-center question-header" title="{{ question.description }}">
                            <div class="question-code">{{ question.code }}</div>
                            <small class="text-muted">{{ question.description[:30] }}...</small>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for machine in machines %}
                    <tr>
                        <td class="sticky-left machine-name">
                            <strong>{{ machine.name }}</strong>
                        </td>
                        {% for question in questions %}
                            {% set key = machine.id ~ '_' ~ question.id %}
                            {% set audits = audit_matrix.get(key, []) %}
                            {% set latest_audit = audits[-1] if audits else None %}
                            
                            <td class="text-center audit-cell" 
                                data-machine-id="{{ machine.id }}" 
                                data-question-id="{{ question.id }}">
                                {% if latest_audit %}
                                    <div class="audit-status-indicator {{ 'status-ok' if latest_audit.status == 'OK' else 'status-nie' }}"
                                         data-bs-toggle="tooltip" 
                                         data-bs-placement="top"
                                         title="Kliknij aby zobaczyć szczegóły">
                                        {% if latest_audit.status == 'OK' %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                        <small class="d-block mt-1">
                                            {{ latest_audit.created_at.strftime('%m/%d') }}
                                        </small>
                                    </div>
                                {% else %}
                                    <div class="audit-status-indicator status-none"
                                         data-bs-toggle="tooltip" 
                                         title="Brak audytu">
                                        <i class="fas fa-question"></i>
                                    </div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Audit details modal -->
    <div class="modal fade" id="auditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Szczegóły Audytu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="auditModalBody">
                    <!-- Content loaded via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- No data state -->
    <div class="text-center py-5">
        <i class="fas fa-database fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Brak danych do wyświetlenia</h4>
        <p class="text-muted mb-4">Nie ma jeszcze żadnych maszyn ani pytań w systemie.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="fas fa-upload me-1"></i>
            Wczytaj dane Excel
        </a>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Handle audit cell clicks
    document.querySelectorAll('.audit-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const machineId = this.dataset.machineId;
            const questionId = this.dataset.questionId;
            
            if (machineId && questionId) {
                loadAuditDetails(machineId, questionId);
            }
        });
    });
});

function loadAuditDetails(machineId, questionId) {
    const modalBody = document.getElementById('auditModalBody');
    modalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Ładowanie...</div>';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('auditModal'));
    modal.show();
    
    // Fetch audit data
    fetch(`/api/audit_data/${machineId}/${questionId}`)
        .then(response => response.json())
        .then(data => {
            let content = '';
            
            if (data.status === 'none') {
                content = `
                    <div class="text-center py-4">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <h5>Brak audytu</h5>
                        <p class="text-muted">Dla tej pary maszyna-pytanie nie przeprowadzono jeszcze audytu.</p>
                    </div>
                `;
            } else {
                const statusBadge = data.status === 'OK' 
                    ? '<span class="badge bg-success"><i class="fas fa-check me-1"></i>OK</span>'
                    : '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>NIE</span>';
                
                content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Status:</h6>
                            <p>${statusBadge}</p>
                            
                            <h6>Audytor:</h6>
                            <p>${data.auditor}</p>
                            
                            <h6>Data audytu:</h6>
                            <p>${data.date}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Opis:</h6>
                            <p>${data.description}</p>
                            
                            ${data.photo_path ? `
                                <h6>Zdjęcie:</h6>
                                <img src="/static/${data.photo_path}" class="img-fluid rounded" alt="Zdjęcie audytu">
                            ` : '<p class="text-muted"><i>Brak zdjęcia</i></p>'}
                        </div>
                    </div>
                `;
            }
            
            modalBody.innerHTML = content;
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Wystąpił błąd podczas ładowania danych audytu.
                </div>
            `;
        });
}
</script>
{% endblock %}
